{% extends "base.html" %}

{% block title %}Dettaglio Fattura - DBLogiX{% endblock %}

{% block header_title %}Dettaglio Fattura PA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/fattura_pa.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="detail-container">
        {% if not invoice_details %}
        <!-- File Not Found -->
        <div class="detail-card">
            <div class="info-section">
                <div class="no-data">
                    <i class="fas fa-file-times text-danger"></i>
                    <h3>Fattura non trovata</h3>
                    <p>Il file della fattura richiesto non Ã¨ stato trovato nel sistema.</p>
                    <a href="{{ url_for('fattura_pa.list_invoices') }}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Torna all'elenco
                    </a>
                </div>
            </div>
        </div>
        {% else %}

        <!-- Header Card with Breadcrumb -->
        <div class="detail-card">
            <div class="detail-header">
                <!-- Breadcrumb -->
                <nav class="breadcrumb-custom mb-3">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="fas fa-home"></i> Home</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('fattura_pa.list_invoices') }}"><i class="fas fa-file-invoice"></i> Fatture PA</a></li>
                        <li class="breadcrumb-item active">
                            {% if invoice_details and invoice_details.invoice_number %}
                                Fattura #{{ invoice_details.invoice_number }}
                            {% else %}
                                Dettaglio Fattura
                            {% endif %}
                        </li>
                    </ol>
                </nav>
                
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="mb-2">
                            <i class="fas fa-file-invoice me-3"></i>
                            {% if invoice_details.invoice_number %}
                                Fattura PA #{{ invoice_details.invoice_number }}
                            {% else %}
                                Fattura PA
                            {% endif %}
                        </h1>
                        <p class="lead mb-0">
                            <i class="fas fa-building me-2"></i>
                            {{ invoice_details.client_name or 'Cliente non specificato' }}
                        </p>
                        <div class="invoice-status">
                            <i class="fas fa-check-circle"></i>
                            <span>Documento Elettronico</span>
                        </div>
                    </div>
                    <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                        <div class="text-white-50">
                            <i class="fas fa-calendar-alt me-2"></i>
                            Creata il {{ invoice_details.created_at }}
                        </div>
                        <div class="text-white-50 mt-1">
                            <i class="fas fa-file-code me-2"></i>
                            {{ invoice_details.size }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="detail-card">
            <div class="info-section">
                <div class="action-buttons">
                    <a href="{{ url_for('fattura_pa.download_invoice', filename=invoice_details.filename) }}" 
                       class="btn btn-success btn-action">
                        <i class="fas fa-download"></i>
                        Scarica XML
                    </a>
                    <a href="{{ url_for('fattura_pa.get_xml_content', filename=invoice_details.filename) }}" 
                       class="btn btn-primary btn-action" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        Visualizza XML
                    </a>
                    {% if current_user.is_admin %}
                    <button class="btn btn-danger btn-action" onclick="deleteInvoice('{{ invoice_details.filename }}')">
                        <i class="fas fa-trash"></i>
                        Elimina
                    </button>
                    {% endif %}
                    <a href="{{ url_for('fattura_pa.list_invoices') }}" class="btn btn-outline-secondary btn-action">
                        <i class="fas fa-arrow-left"></i>
                        Elenco Fatture
                    </a>
                </div>
            </div>
        </div>

        <!-- Tabbed Information -->
        <div class="detail-card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="invoiceTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                            <i class="fas fa-info-circle me-2"></i>Informazioni Generali
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="company-tab" data-bs-toggle="tab" data-bs-target="#company" type="button" role="tab">
                            <i class="fas fa-building me-2"></i>Azienda & Cliente
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payment-tab" data-bs-toggle="tab" data-bs-target="#payment" type="button" role="tab">
                            <i class="fas fa-credit-card me-2"></i>Pagamento
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="transmission-tab" data-bs-toggle="tab" data-bs-target="#transmission" type="button" role="tab">
                            <i class="fas fa-paper-plane me-2"></i>Trasmissione
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="xml-tab" data-bs-toggle="tab" data-bs-target="#xml" type="button" role="tab">
                            <i class="fas fa-code me-2"></i>XML
                        </button>
                    </li>
                </ul>
            </div>
            
            <div class="tab-content" id="invoiceTabsContent">
                <!-- General Information Tab -->
                <div class="tab-pane fade show active" id="general" role="tabpanel">
                    <div class="info-section">
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-hashtag me-1"></i>
                                    Numero Fattura
                                </div>
                                <div class="info-value highlight">
                                    {{ invoice_details.invoice_number or 'Non specificato' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-calendar me-1"></i>
                                    Data Fattura
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.invoice_date or 'Non specificata' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-file-alt me-1"></i>
                                    Tipo Documento
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.document_type or 'Fattura Elettronica' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-coins me-1"></i>
                                    Valuta
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.currency or 'EUR' }}
                                </div>
                            </div>
                            {% if invoice_details.causale %}
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <div class="info-label">
                                    <i class="fas fa-comment me-1"></i>
                                    Causale
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.causale }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.ddt_reference %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-truck me-1"></i>
                                    Riferimento DDT
                                </div>
                                <div class="info-value highlight">
                                    #{{ invoice_details.ddt_reference }}
                                </div>
                            </div>
                            {% if invoice_details.ddt_date %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-calendar me-1"></i>
                                    Data DDT
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.ddt_date }}
                                </div>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Company & Client Tab -->
                <div class="tab-pane fade" id="company" role="tabpanel">
                    <div class="info-section">
                        <h3 class="section-title">
                            <i class="fas fa-building"></i>
                            Cedente / Prestatore
                        </h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-building me-1"></i>
                                    Denominazione
                                </div>
                                <div class="info-value highlight">
                                    {{ invoice_details.company_name or 'Non specificato' }}
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-id-card me-1"></i>
                                    Partita IVA
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.company_vat or 'Non specificata' }}
                                </div>
                            </div>
                            {% if invoice_details.company_fiscal_code %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-barcode me-1"></i>
                                    Codice Fiscale
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.company_fiscal_code }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.company_regime %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-gavel me-1"></i>
                                    Regime Fiscale
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.company_regime }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.company_address %}
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <div class="info-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    Indirizzo Completo
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.company_address }}
                                    {% if invoice_details.company_cap %}, {{ invoice_details.company_cap }}{% endif %}
                                    {% if invoice_details.company_city %} {{ invoice_details.company_city }}{% endif %}
                                    {% if invoice_details.company_province %} ({{ invoice_details.company_province }}){% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <hr class="my-4">

                        <h3 class="section-title">
                            <i class="fas fa-user"></i>
                            Cessionario / Committente
                        </h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-user me-1"></i>
                                    Denominazione
                                </div>
                                <div class="info-value highlight">
                                    {{ invoice_details.client_name or 'Non specificato' }}
                                </div>
                            </div>
                            {% if invoice_details.client_vat %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-id-card me-1"></i>
                                    Partita IVA
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.client_vat }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.client_fiscal_code %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-barcode me-1"></i>
                                    Codice Fiscale
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.client_fiscal_code }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.client_address %}
                            <div class="info-item" style="grid-column: 1 / -1;">
                                <div class="info-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    Indirizzo Completo
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.client_address }}
                                    {% if invoice_details.client_cap %}, {{ invoice_details.client_cap }}{% endif %}
                                    {% if invoice_details.client_city %} {{ invoice_details.client_city }}{% endif %}
                                    {% if invoice_details.client_province %} ({{ invoice_details.client_province }}){% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Payment Tab -->
                <div class="tab-pane fade" id="payment" role="tabpanel">
                    <div class="info-section">
                        {% if invoice_details.payment_amount or invoice_details.payment_method %}
                        <div class="info-grid">
                            {% if invoice_details.payment_amount %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-euro-sign me-1"></i>
                                    Importo
                                </div>
                                <div class="info-value highlight">
                                    â¬ {{ invoice_details.payment_amount }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.payment_method %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-credit-card me-1"></i>
                                    ModalitÃ  Pagamento
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.payment_method }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.payment_due_date %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    Scadenza
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.payment_due_date }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.iban %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-university me-1"></i>
                                    IBAN
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.iban }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data">
                            <i class="fas fa-credit-card" style="opacity: 0.3; font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Nessuna informazione di pagamento disponibile per questa fattura.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Transmission Tab -->
                <div class="tab-pane fade" id="transmission" role="tabpanel">
                    <div class="info-section">
                        {% if invoice_details.transmission_id or invoice_details.destination_code %}
                        <div class="info-grid">
                            {% if invoice_details.transmission_id %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-fingerprint me-1"></i>
                                    ID Trasmissione
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.transmission_id }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.transmission_format %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-code me-1"></i>
                                    Formato
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.transmission_format }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.destination_code %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-qrcode me-1"></i>
                                    Codice Destinatario
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.destination_code }}
                                </div>
                            </div>
                            {% endif %}
                            {% if invoice_details.pec_destination %}
                            <div class="info-item">
                                <div class="info-label">
                                    <i class="fas fa-envelope me-1"></i>
                                    PEC Destinatario
                                </div>
                                <div class="info-value">
                                    {{ invoice_details.pec_destination }}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="no-data">
                            <i class="fas fa-paper-plane" style="opacity: 0.3; font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Nessuna informazione di trasmissione disponibile per questa fattura.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- XML Tab -->
                <div class="tab-pane fade" id="xml" role="tabpanel">
                    <div class="info-section">
                        {% if invoice_details.xml_content %}
                        <div class="xml-preview" id="xmlPreview">{{ invoice_details.xml_content[:1000] }}{% if invoice_details.xml_content|length > 1000 %}...{% endif %}</div>
                        {% if invoice_details.xml_content|length > 1000 %}
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-primary" onclick="toggleXmlPreview()">
                                <i class="fas fa-expand-alt me-1"></i>
                                <span id="toggleText">Mostra tutto il contenuto</span>
                            </button>
                        </div>
                        {% endif %}
                        {% else %}
                        <div class="no-data">
                            <i class="fas fa-code" style="opacity: 0.3; font-size: 3rem; margin-bottom: 1rem;"></i>
                            <p>Contenuto XML non disponibile per questa fattura.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Bootstrap tabs
    var triggerTabList = [].slice.call(document.querySelectorAll('#invoiceTabs button'))
    triggerTabList.forEach(function (triggerEl) {
        var tabTrigger = new bootstrap.Tab(triggerEl)
        
        triggerEl.addEventListener('click', function (event) {
            event.preventDefault()
            tabTrigger.show()
        })
    })

    // Toggle XML preview
    let xmlExpanded = false;
    const fullXmlContent = `{{ invoice_details.xml_content | safe }}`;
    
    function toggleXmlPreview() {
        const preview = document.getElementById('xmlPreview');
        const toggleText = document.getElementById('toggleText');
        
        if (!xmlExpanded) {
            preview.textContent = fullXmlContent;
            toggleText.textContent = 'Mostra meno contenuto';
            xmlExpanded = true;
        } else {
            preview.textContent = fullXmlContent.substring(0, 1000) + '...';
            toggleText.textContent = 'Mostra tutto il contenuto';
            xmlExpanded = false;
        }
    }
    
    // Delete invoice function
    function deleteInvoice(filename) {
        if (confirm('Sei sicuro di voler eliminare questa fattura? Questa azione non puÃ² essere annullata.')) {
            fetch(`/fattura_pa/delete/${filename}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Fattura eliminata con successo!');
                    window.location.href = "{{ url_for('fattura_pa.list_invoices') }}";
                } else {
                    alert('Errore durante l\'eliminazione: ' + data.message);
                }
            })
            .catch(error => {
                alert('Errore di rete durante l\'eliminazione: ' + error);
            });
        }
    }
    
    // Copy to clipboard functionality for data values
    document.addEventListener('DOMContentLoaded', function() {
        const dataValues = document.querySelectorAll('.info-value');
        dataValues.forEach(value => {
            if (value.textContent.trim() !== 'Non specificato' && value.textContent.trim() !== 'Non specificata') {
                value.style.cursor = 'pointer';
                value.title = 'Clicca per copiare negli appunti';
                value.addEventListener('click', () => {
                    copyToClipboard(value.textContent.trim());
                    
                    // Visual feedback
                    const originalText = value.innerHTML;
                    value.innerHTML = '<i class="fas fa-check text-success"></i> Copiato!';
                    setTimeout(() => {
                        value.innerHTML = originalText;
                    }, 1500);
                });
            }
        });
    });
    
    function copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(function() {
                console.log('Text copied to clipboard');
            }).catch(function(err) {
                console.error('Error copying text: ', err);
            });
        } else {
            // Fallback for older browsers
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
        }
    }
</script>
{% endblock %} 