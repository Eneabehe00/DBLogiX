{% extends "base.html" %}

{% block title %}Scansione Ticket - {{ task_ticket.task.task_number }}{% endblock %}

{% block extra_css %}
<style>
    .scanner-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .camera-section {
        background: #000;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        position: relative;
        overflow: hidden;
    }
    
    #camera-preview {
        width: 100%;
        max-width: 400px;
        height: 300px;
        border-radius: 10px;
        margin: 0 auto;
        display: block;
        background: #222;
    }
    
    .camera-controls {
        text-align: center;
        margin-top: 15px;
    }
    
    .camera-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 50px;
        padding: 12px 25px;
        color: white;
        font-weight: 600;
        margin: 0 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }
    
    .camera-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        color: white;
    }
    
    .camera-btn.danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
    }
    
    .camera-btn.danger:hover {
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
    }
    
    .product-item {
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin: 15px 0;
        transition: all 0.3s ease;
        background: #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-item.scanned {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9, #e8f8e8);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2);
    }
    
    .product-item.error {
        border-color: #dc3545;
        background: linear-gradient(135deg, #fff8f8, #ffe6e6);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.2);
    }
    
    .product-item.selected {
        border-color: #007bff !important;
        background: linear-gradient(135deg, #f8f9ff, #e6f0ff) !important;
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.3) !important;
        transform: translateY(-3px) !important;
    }
    
    .scan-status {
        font-size: 1.2em;
        font-weight: bold;
        padding: 8px 15px;
        border-radius: 20px;
        display: inline-block;
        min-width: 120px;
        text-align: center;
    }
    
    .scan-status.success {
        color: white;
        background: linear-gradient(135deg, #28a745, #20c997);
    }
    
    .scan-status.error {
        color: white;
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    
    .scan-status.pending {
        color: #6c757d;
        background: #f8f9fa;
        border: 2px solid #dee2e6;
    }
    
    .progress-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: conic-gradient(#28a745 0deg, #28a745 0deg, #e9ecef 0deg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        font-size: 1.1em;
        margin: 0 auto;
    }
    
    .scan-feedback {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        padding: 25px 35px;
        border-radius: 15px;
        text-align: center;
        font-size: 1.4em;
        font-weight: bold;
        min-width: 320px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        backdrop-filter: blur(10px);
    }
    
    .scan-feedback.success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .scan-feedback.error {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
    }
    
    .instruction-panel {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .status-indicator {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    
    .status-indicator.success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .status-indicator.error {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
    }
    
    .status-indicator.pending {
        background: #f8f9fa;
        color: #6c757d;
        border: 2px solid #dee2e6;
    }
    
    .scan-target-btn {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        border-radius: 20px;
        padding: 8px 20px;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .scan-target-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 18px rgba(0, 123, 255, 0.4);
        color: white;
    }
    
    @media (max-width: 768px) {
        #camera-preview {
            height: 250px;
        }
        
        .product-item {
            padding: 15px;
        }
        
        .scan-feedback {
            min-width: 280px;
            font-size: 1.2em;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4" data-task-ticket-id="{{ task_ticket.id }}">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-qrcode text-primary"></i> Scansione QR Code</h2>
                    <h5 class="text-muted">Task: {{ task_ticket.task.task_number }} - Ticket #{{ task_ticket.ticket.NumTicket }}</h5>
                </div>
                <div>
                    <a href="{{ url_for('tasks.view_task', task_id=task_ticket.task.id_task) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Torna al Task
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="instruction-panel">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <div class="progress-circle" id="progress-circle" data-progress="{{ task_ticket.scan_progress_percentage }}">
                        {{ task_ticket.scan_progress_percentage }}%
                        </div>
                    </div>
                    <div class="col-md-9">
                        <h4 class="mb-2">üì± Scansione Mobile</h4>
                        <p class="mb-2"><strong>{{ task_ticket.scanned_items }} di {{ task_ticket.total_items }} prodotti verificati</strong></p>
                        <p class="mb-0">üéØ Scansiona i QR code dei prodotti per verificare ticket e prodotto contemporaneamente</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-info h-100">
                <div class="card-body">
                    <h6 class="text-center mb-3"><i class="fas fa-info-circle"></i> Come Funziona</h6>
                    <div class="text-center">
                        <small class="d-block mb-2">üì∑ <strong>Attiva Fotocamera</strong></small>
                        <small class="d-block mb-2">üé´ <strong>Scansiona QR Prodotto</strong></small>
                        <small class="d-block mb-2">‚úÖ <strong>Verifica Ticket + Prodotto</strong></small>
                        <small class="d-block">üîÑ <strong>Prodotto Successivo</strong></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Camera Section -->
            <div class="scanner-container">
        <div class="camera-section">
            <video id="camera-preview" playsinline></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            
            <div class="camera-controls">
                <button id="start-camera" class="camera-btn">
                    <i class="fas fa-camera"></i> Attiva Fotocamera
                </button>
                <button id="stop-camera" class="camera-btn danger" style="display: none;">
                    <i class="fas fa-stop"></i> Ferma Fotocamera
                </button>
                <button id="switch-camera" class="camera-btn" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Cambia Camera
                </button>
                    </div>
            
            <div class="text-center mt-3">
                <div id="scan-status" class="text-white">
                    <i class="fas fa-mobile-alt"></i> Pronto per la scansione - Area completa attiva
                </div>
            </div>
        </div>
    </div>

    <!-- Products List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> Prodotti da Verificare ({{ ticket_lines|length }})</h5>
                </div>
                <div class="card-body">
                    {% if ticket_lines %}
                    {% for line in ticket_lines %}
                    <div class="product-item {% if line.IdLineaTicket in scan_results %}{{ 'scanned' if scan_results[line.IdLineaTicket].status == 'success' else 'error' }}{% endif %}" 
                         data-line-id="{{ line.IdLineaTicket }}" 
                         data-product-id="{{ line.IdArticulo }}"
                         id="product-{{ line.IdLineaTicket }}">
                        
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <div class="status-indicator {% if line.IdLineaTicket in scan_results %}{{ 'success' if scan_results[line.IdLineaTicket].status == 'success' else 'error' }}{% else %}pending{% endif %}">
                                {% if line.IdLineaTicket in scan_results %}
                                    {% set scan = scan_results[line.IdLineaTicket] %}
                                    {% if scan.status == 'success' %}
                                        <i class="fas fa-check fa-2x"></i>
                                        {% else %}
                                        <i class="fas fa-times fa-2x"></i>
                                        {% endif %}
                                    {% else %}
                                    <i class="fas fa-clock fa-2x"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <h6 class="mb-2">
                                    <i class="fas fa-box text-primary"></i>
                                    <strong>{{ line.Descripcion[:50] }}{% if line.Descripcion|length > 50 %}...{% endif %}</strong>
                                </h6>
                                <div class="row">
                                    <div class="col-sm-6">
                                        <small class="text-muted">
                                            <strong>ID Prodotto:</strong> {{ line.IdArticulo }}<br>
                                            <strong>Quantit√†:</strong> {{ line.Cantidad or 0 }}
                                        </small>
                                    </div>
                                    <div class="col-sm-6">
                                        <small class="text-muted">
                                            {% if line.FechaVencimiento %}
                                            <strong>Scadenza:</strong> {{ line.FechaVencimiento.strftime('%d/%m/%Y') if line.FechaVencimiento else 'N/A' }}<br>
                                            {% endif %}
                                            <strong>Linea:</strong> #{{ line.IdLineaTicket }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4 text-center">
                                {% if line.IdLineaTicket in scan_results %}
                                    {% set scan = scan_results[line.IdLineaTicket] %}
                                    <div class="scan-status {{ scan.status }}">
                                        {{ scan.formatted_status }}
                                    </div>
                                    <small class="d-block mt-1 text-muted">{{ scan.scanned_at.strftime('%H:%M:%S') }}</small>
                                    {% if scan.error_message %}
                                    <div class="alert alert-danger mt-2 py-2 px-3">
                                        <small><i class="fas fa-exclamation-triangle"></i> {{ scan.error_message }}</small>
                                    </div>
                                    {% endif %}
                                {% else %}
                                <div class="scan-status pending">
                                    <i class="fas fa-qrcode"></i> In Attesa
                                </div>
                                <button class="btn scan-target-btn mt-2" 
                                        data-line-id="{{ line.IdLineaTicket }}"
                                        onclick="selectProduct(this.dataset.lineId)">
                                    <i class="fas fa-crosshairs"></i> Seleziona
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-box-open fa-4x text-muted mb-3"></i>
                        <h5 class="text-muted">Nessun prodotto nel ticket</h5>
                        <p class="text-muted">Questo ticket non contiene prodotti da verificare.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Completion Status -->
    {% if task_ticket.is_scan_completed %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <h4 class="alert-heading"><i class="fas fa-trophy"></i> Ticket Completato!</h4>
                <p>üéâ Ottimo lavoro! Tutti i prodotti di questo ticket sono stati verificati con successo.</p>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('tasks.view_task', task_id=task_ticket.task.id_task) }}" class="btn btn-success btn-lg">
                        <i class="fas fa-arrow-left"></i> Torna al Task
                    </a>
                    <small class="text-muted">
                        <i class="fas fa-check-circle"></i> Completato il {{ task_ticket.completed_at.strftime('%d/%m/%Y alle %H:%M') if task_ticket.completed_at else 'ora' }}
                    </small>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Scan Feedback Overlay -->
<div id="scan-feedback" class="scan-feedback" style="display: none;"></div>

<!-- QR Code Detection Library -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üì± Initializing mobile QR scanner...');
    
    // Global variables
    const video = document.getElementById('camera-preview');
    const canvas = document.getElementById('camera-canvas');
    const ctx = canvas.getContext('2d');
    const startBtn = document.getElementById('start-camera');
    const stopBtn = document.getElementById('stop-camera');
    const switchBtn = document.getElementById('switch-camera');
    const scanStatus = document.getElementById('scan-status');
    
    // Get task ticket ID from data attribute
    const taskTicketId = parseInt(document.querySelector('.container-fluid').getAttribute('data-task-ticket-id')) || 0;
    
    let currentStream = null;
    let currentFacingMode = 'environment'; // Start with back camera
    let isScanning = false;
    let currentSelectedProduct = null;
    let scanCooldown = false;
    
    // Initialize progress circle
    const progressCircle = document.getElementById('progress-circle');
    const initialProgress = parseInt(progressCircle.dataset.progress) || 0;
    const degrees = initialProgress * 3.6;
    progressCircle.style.background = `conic-gradient(#28a745 ${degrees}deg, #e9ecef ${degrees}deg)`;
    
    // Camera management
    async function startCamera() {
        try {
            scanStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Avvio fotocamera...';
            
            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };
            
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            
            video.onloadedmetadata = () => {
                video.play();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                switchBtn.style.display = 'inline-block';
                
                isScanning = true;
                scanStatus.innerHTML = '<i class="fas fa-camera text-success"></i> Fotocamera attiva - Scansione area completa';
                
                // Start scanning loop
                scanLoop();
                console.log('üì∑ Camera started successfully');
            };
            
        } catch (error) {
            console.error('‚ùå Camera error:', error);
            scanStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Errore fotocamera';
            showScanFeedback('‚ùå Errore accesso fotocamera. Verifica i permessi.', false);
        }
    }
    
    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        
        video.srcObject = null;
        isScanning = false;
        
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
        switchBtn.style.display = 'none';
        
        scanStatus.innerHTML = '<i class="fas fa-mobile-alt"></i> Fotocamera disattivata';
        console.log('üì∑ Camera stopped');
    }
    
    async function switchCamera() {
        stopCamera();
        currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        
        setTimeout(() => {
            startCamera();
        }, 500);
        
        console.log('üîÑ Switched to camera:', currentFacingMode);
    }
    
    // QR Code scanning loop - More frequent scanning
    function scanLoop() {
        if (!isScanning || !video.videoWidth) {
            setTimeout(scanLoop, 50); // Faster retry
            return;
        }
        
        // Draw current frame to canvas
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Try to detect QR code on entire frame
        tryQRDetection();
        
        // Continue scanning at 20 FPS for better detection
        if (isScanning) {
            setTimeout(scanLoop, 50);
        }
    }
    
    // Enhanced QR detection using jsQR on full frame
    function tryQRDetection() {
        if (scanCooldown) return;
        
        try {
            // Get the full frame image data
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            
            // Use jsQR to detect QR codes in the entire frame
            if (typeof jsQR !== 'undefined') {
                const qrCode = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (qrCode) {
                    console.log('üì± QR Code detected:', qrCode.data);
                    processQRCode(qrCode.data);
                    return;
                }
            }
            
        } catch (error) {
            console.log('Scan detection error:', error);
        }
    }
    
    // Manual QR input (fallback)
    function addManualInput() {
        if (document.getElementById('manual-qr-input')) return;
        
        const inputDiv = document.createElement('div');
        inputDiv.id = 'manual-qr-input';
        inputDiv.className = 'text-center mt-3';
        inputDiv.innerHTML = `
            <div class="input-group" style="max-width: 400px; margin: 0 auto;">
                <input type="text" class="form-control form-control-lg" 
                       id="qr-manual-input" placeholder="Inserisci codice QR manualmente"
                       style="font-size: 16px;">
                <div class="input-group-append">
                    <button class="btn btn-primary" onclick="processManualQR()">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
            <small class="text-muted d-block mt-2">
                <i class="fas fa-keyboard"></i> Input manuale se la fotocamera non rileva il codice
            </small>
        `;
        
        document.querySelector('.camera-controls').appendChild(inputDiv);
        
        // Auto-submit on Enter
        document.getElementById('qr-manual-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                processManualQR();
            }
        });
    }
    
    // Process manually entered QR code
    window.processManualQR = function() {
        const input = document.getElementById('qr-manual-input');
        const qrCode = input.value.trim();
        
        if (qrCode) {
            input.value = '';
            processQRCode(qrCode);
        }
    };
    
    // Process detected QR code
    function processQRCode(qrCode) {
        if (scanCooldown) return;
        
        scanCooldown = true;
        setTimeout(() => { scanCooldown = false; }, 2000);
        
        console.log('üì± QR Code detected:', qrCode);
        scanStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verificando ticket e prodotto...';
        
        // Determine which product to scan
        let ticketLineId = currentSelectedProduct;
        if (!ticketLineId) {
            // Don't auto-select - let server handle product verification
            ticketLineId = null;
        }
        
        // Send to server (even without specific product selected)
        fetch('{{ url_for("tasks.api_scan_product") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task_ticket_id: taskTicketId,
                scanned_code: qrCode,
                ticket_line_id: ticketLineId
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('üì° Server response:', data);
            
            if (data.success) {
                // Format success message with ticket and product details
                let successMsg = `‚úÖ Ticket Verificato!`;
                if (data.scan_details) {
                    successMsg += `\nüé´ Ticket #${data.scan_details.ticket_number}`;
                    successMsg += `\nüì¶ Prodotto #${data.scan_details.product_id}`;
                    if (data.scan_details.weight > 0) {
                        successMsg += `\n‚öñÔ∏è Peso: ${data.scan_details.weight.toFixed(3)}kg`;
                    }
                    successMsg += `\nüìÖ ${data.scan_details.scan_date} ${data.scan_details.scan_time}`;
                }
                
                showScanFeedback(successMsg, true);
                
                // Find the correct product line to update (might be different from ticketLineId if auto-detected)
                let productLineToUpdate = ticketLineId;
                if (!productLineToUpdate && data.scan_details) {
                    // Server found the product automatically - find the corresponding line by product ID
                    const productItems = document.querySelectorAll('.product-item');
                    for (let item of productItems) {
                        if (parseInt(item.dataset.productId) === data.scan_details.product_id) {
                            productLineToUpdate = parseInt(item.dataset.lineId);
                            break;
                        }
                    }
                }
                
                if (productLineToUpdate) {
                    updateProductStatus(productLineToUpdate, 'success', data.message, data.scan_details);
                }
                scanStatus.innerHTML = '<i class="fas fa-check text-success"></i> Ticket e prodotto verificati!';
                
            } else {
                // Format error message with available details
                let errorMsg = `‚ùå ${data.message}`;
                if (data.scan_details) {
                    errorMsg += `\n\nüìã Dettagli scansione:`;
                    errorMsg += `\nüé´ Ticket scansionato: #${data.scan_details.ticket_number}`;
                    errorMsg += `\nüì¶ Prodotto scansionato: #${data.scan_details.product_id}`;
                    if (data.scan_details.expected_ticket) {
                        errorMsg += `\nüéØ Ticket atteso: #${data.scan_details.expected_ticket}`;
                    }
                    if (data.scan_details.weight > 0) {
                        errorMsg += `\n‚öñÔ∏è Peso: ${data.scan_details.weight.toFixed(3)}kg`;
                    }
                }
                
                showScanFeedback(errorMsg, false);
                updateProductStatus(ticketLineId, 'error', data.message, data.scan_details);
                scanStatus.innerHTML = '<i class="fas fa-times text-danger"></i> Errore verifica';
            }
            
            // Update progress and move to next
            updateProgress();
            currentSelectedProduct = null;
            
            setTimeout(() => {
                if (isScanning) {
                    selectNextUnscanned();
                    scanStatus.innerHTML = '<i class="fas fa-camera text-success"></i> Pronto per il prossimo QR code';
                }
            }, 1500);
        })
        .catch(error => {
            console.error('‚ùå Network error:', error);
            showScanFeedback('‚ùå Errore di connessione. Riprova.', false);
            scanStatus.innerHTML = '<i class="fas fa-wifi text-warning"></i> Errore connessione';
        });
    }
    
    // Update product visual status
    function updateProductStatus(lineId, status, message, scan_details) {
        const productItem = document.getElementById(`product-${lineId}`);
        if (productItem) {
            productItem.classList.remove('scanned', 'error', 'selected');
            productItem.classList.add(status === 'success' ? 'scanned' : 'error');
            
            // Update status indicator
            const statusIndicator = productItem.querySelector('.status-indicator');
            statusIndicator.className = `status-indicator ${status === 'success' ? 'success' : 'error'}`;
            statusIndicator.innerHTML = status === 'success' ? 
                '<i class="fas fa-check fa-2x"></i>' : 
                '<i class="fas fa-times fa-2x"></i>';
            
            // Update scan status text with detailed information
            const scanStatusEl = productItem.querySelector('.scan-status');
            scanStatusEl.className = `scan-status ${status === 'success' ? 'success' : 'error'}`;
            
            if (status === 'success' && scan_details) {
                scanStatusEl.innerHTML = `
                    <i class="fas fa-check-circle"></i> Verificato
                    <br><small>Ticket #${scan_details.ticket_number}</small>
                    ${scan_details.weight > 0 ? `<br><small>${scan_details.weight.toFixed(3)}kg</small>` : ''}
                `;
            } else if (status === 'success') {
                scanStatusEl.innerHTML = '<i class="fas fa-check-circle"></i> Verificato';
            } else {
                scanStatusEl.innerHTML = '<i class="fas fa-times-circle"></i> Errore';
            }
            
            // Add detailed scan information if available
            if (scan_details) {
                // Find or create scan details section
                let detailsDiv = productItem.querySelector('.scan-details');
                if (!detailsDiv) {
                    detailsDiv = document.createElement('div');
                    detailsDiv.className = 'scan-details mt-2';
                    productItem.appendChild(detailsDiv);
                }
                
                if (status === 'success') {
                    detailsDiv.innerHTML = `
                        <div class="alert alert-success py-2 px-3">
                            <small>
                                <i class="fas fa-info-circle"></i> 
                                <strong>Ticket #${scan_details.ticket_number}</strong> - 
                                Prodotto #${scan_details.product_id}
                                ${scan_details.weight > 0 ? ` - ${scan_details.weight.toFixed(3)}kg` : ''}
                                <br>üìÖ ${scan_details.scan_date} ${scan_details.scan_time}
                            </small>
                        </div>
                    `;
                } else {
                    detailsDiv.innerHTML = `
                        <div class="alert alert-danger py-2 px-3">
                            <small>
                                <i class="fas fa-exclamation-triangle"></i> 
                                Ticket scansionato: #${scan_details.ticket_number}
                                ${scan_details.expected_ticket ? ` (atteso: #${scan_details.expected_ticket})` : ''}
                                <br>Prodotto: #${scan_details.product_id}
                                ${scan_details.weight > 0 ? ` - ${scan_details.weight.toFixed(3)}kg` : ''}
                            </small>
                        </div>
                    `;
                }
            }
            
            // Scroll to next item
            setTimeout(() => {
                const nextUnscanned = document.querySelector('.product-item:not(.scanned):not(.error)');
                if (nextUnscanned) {
                    nextUnscanned.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }, 1000);
        }
    }
    
    // Progress management
    function updateProgress() {
        const totalItems = document.querySelectorAll('.product-item').length;
        const scannedItems = document.querySelectorAll('.product-item.scanned').length;
        const percentage = totalItems > 0 ? Math.round((scannedItems / totalItems) * 100) : 0;
        
        // Update progress circle
        const progressCircle = document.getElementById('progress-circle');
        const degrees = percentage * 3.6;
        progressCircle.style.background = `conic-gradient(#28a745 ${degrees}deg, #e9ecef ${degrees}deg)`;
        progressCircle.textContent = `${percentage}%`;
        
        console.log(`üìä Progress: ${scannedItems}/${totalItems} (${percentage}%)`);
        
        // Check if completed
        if (percentage === 100) {
            setTimeout(() => {
                showScanFeedback('üéâ Tutti i prodotti verificati! Reindirizzamento...', true);
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }, 1500);
        }
    }
    
    // Product selection
    window.selectProduct = function(lineId) {
        // Remove previous selection
        document.querySelectorAll('.product-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Select new product
        const productItem = document.getElementById(`product-${lineId}`);
        if (productItem && !productItem.classList.contains('scanned') && !productItem.classList.contains('error')) {
            productItem.classList.add('selected');
            currentSelectedProduct = lineId;
            
            scanStatus.innerHTML = '<i class="fas fa-crosshairs text-primary"></i> Prodotto selezionato - Mostra QR code alla camera';
            
            // Scroll to selected item
            productItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            console.log('üéØ Selected product:', lineId);
        }
    };
    
    // Auto-select next unscanned product
    function selectNextUnscanned() {
        const unscannedItems = document.querySelectorAll('.product-item:not(.scanned):not(.error)');
        if (unscannedItems.length > 0) {
            const nextLineId = parseInt(unscannedItems[0].dataset.lineId);
            selectProduct(nextLineId);
        }
    }
    
    // Feedback display
    function showScanFeedback(message, success) {
        const feedback = document.getElementById('scan-feedback');
        feedback.className = `scan-feedback ${success ? 'success' : 'error'}`;
        feedback.innerHTML = `
            <i class="fas fa-${success ? 'check-circle' : 'times-circle'} fa-2x mb-2"></i><br>
            ${message}
        `;
        feedback.style.display = 'block';
        
        setTimeout(() => {
            feedback.style.display = 'none';
        }, 3000);
    }
    
    // Event listeners
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    switchBtn.addEventListener('click', switchCamera);
    
    // Initialize
    console.log('üì± QR Scanner initialized');
    
    // Add manual input fallback after 3 seconds
    setTimeout(addManualInput, 3000);
    
    // Auto-select first unscanned product
    setTimeout(selectNextUnscanned, 1000);
    
    // Check for camera availability
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        scanStatus.innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Fotocamera non supportata';
        showScanFeedback('‚ùå Fotocamera non disponibile su questo dispositivo', false);
    }
});
</script>
{% endblock %} 