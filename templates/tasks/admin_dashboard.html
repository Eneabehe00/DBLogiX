{% extends "base.html" %}

{% block title %}Task Management - Dashboard Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header shadow-sm mb-4">
    <div class="container-fluid">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('warehouse.index') }}" class="text-white">Home</a></li>
                <li class="breadcrumb-item active text-white-50" aria-current="page">Task Management</li>
            </ol>
        </nav>
        <div class="row align-items-center mt-3">
            <div class="col-md-8">
                <h1 class="page-title mb-0">
                    <i class="fas fa-tasks me-2"></i>Task Management
                </h1>
                <p class="page-subtitle mt-2 mb-0">
                    <span class="text-white-50">Gestione completa dei task di magazzino</span>
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="d-grid d-md-block gap-2">
                    <a href="{{ url_for('tasks.create_task') }}" class="action-btn mb-2 mb-md-0">
                        <i class="fas fa-plus"></i> Crea Nuovo Task
                    </a>
                    <a href="{{ url_for('tasks.notifications') }}" class="action-btn position-relative">
                        <i class="fas fa-bell"></i> Notifiche
                        {% if stats.pending_tasks > 0 %}
                        <span class="badge bg-danger position-absolute" style="top: -8px; right: -8px; font-size: 0.7rem;">{{ stats.pending_tasks }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stats-card primary">
                <div class="stats-icon">
                    <i class="fas fa-list"></i>
                </div>
                <div class="stats-number">{{ stats.total_tasks }}</div>
                <div class="stats-label">Task Totali</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stats-card warning">
                <div class="stats-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stats-number">{{ stats.pending_tasks }}</div>
                <div class="stats-label">In Attesa</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stats-card info">
                <div class="stats-icon">
                    <i class="fas fa-play"></i>
                </div>
                <div class="stats-number">{{ stats.in_progress_tasks }}</div>
                <div class="stats-label">In Corso</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stats-card success">
                <div class="stats-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="stats-number">{{ stats.completed_tasks }}</div>
                <div class="stats-label">Completati</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-transparent">
            <h5 class="mb-0"><i class="fas fa-filter me-2 text-primary"></i>Filtri</h5>
        </div>
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" 
                               class="form-control" 
                               id="title" 
                               name="title" 
                               value="{{ current_filters.title }}"
                               placeholder="Cerca per titolo...">
                    </div>
                    <div class="col-md-2">
                        <input type="date" 
                               class="form-control" 
                               id="date_from" 
                               name="date_from" 
                               value="{{ current_filters.date_from }}">
                    </div>
                    <div class="col-md-2">
                        <input type="date" 
                               class="form-control" 
                               id="date_to" 
                               name="date_to" 
                               value="{{ current_filters.date_to }}">
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="priority" name="priority">
                            <option value="">Tutte le priorità</option>
                            <option value="low" {% if current_filters.priority == 'low' %}selected{% endif %}>Bassa</option>
                            <option value="medium" {% if current_filters.priority == 'medium' %}selected{% endif %}>Media</option>
                            <option value="high" {% if current_filters.priority == 'high' %}selected{% endif %}>Alta</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="status" name="status">
                            <option value="">Tutti gli stati</option>
                            <option value="pending" {% if current_filters.status == 'pending' %}selected{% endif %}>In Attesa</option>
                            <option value="assigned" {% if current_filters.status == 'assigned' %}selected{% endif %}>Assegnato</option>
                            <option value="in_progress" {% if current_filters.status == 'in_progress' %}selected{% endif %}>In Corso</option>
                            <option value="completed" {% if current_filters.status == 'completed' %}selected{% endif %}>Completato</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Active Tasks Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-tasks me-2 text-primary"></i>Task Attivi ({{ active_tasks|length }})
            </h5>
            <small class="text-muted">Task in corso di lavorazione</small>
        </div>
        <div class="card-body">
            {% if active_tasks %}
            <div class="row">
                {% for task in active_tasks %}
                <div class="col-lg-6 col-xl-4 mb-3">
                    <div class="task-card task-{{ task.status }}">
                        <div class="task-card-header">
                            <h6 class="task-card-title">{{ task.task_number }}</h6>
                            <div>
                                <span class="task-status-badge task-status-{{ task.status }}">
                                    {{ task.status.replace('_', ' ').title() }}
                                </span>
                                <span class="task-priority-badge task-priority-{{ task.priority }}">
                                    {{ task.priority.title() }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="task-card-body">
                            <h6 class="mb-2">{{ task.title }}</h6>
                            
                            <!-- Progress -->
                            <div class="task-progress">
                                <div class="task-progress-label">
                                    <span>Progresso</span>
                                    <span>{{ task.completed_tickets }}/{{ task.total_tickets }}</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill {% if task.progress_percentage < 100 %}warning{% endif %}" 
                                         style="width: {{ task.progress_percentage }}%"></div>
                                </div>
                            </div>

                            <!-- Task Meta -->
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <span class="task-meta-label">Creato</span>
                                    <span class="task-meta-value">{{ task.created_at.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="task-meta-item">
                                    <span class="task-meta-label">Assegnato a</span>
                                    <span class="task-meta-value">{{ task.assignee.username if task.assignee else 'Non assegnato' }}</span>
                                </div>
                            </div>

                            {% if task.deadline %}
                            <div class="mt-2">
                                <span class="task-meta-label">Scadenza:</span>
                                <span class="{% if task.deadline < now() %}text-danger{% elif (task.deadline - now()).days < 1 %}text-warning{% endif %}">
                                    {{ task.deadline.strftime('%d/%m/%Y %H:%M') }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="task-card-footer">
                            <div class="btn-group">
                                <a href="{{ url_for('tasks.view_task', task_id=task.id_task) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Visualizza
                                </a>
                                {% if not task.assignee %}
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#assignModal{{ task.id_task }}">
                                    <i class="fas fa-user-plus"></i> Assegna
                                </button>
                                {% endif %}
                                {% if task.is_completed and not task.ddt_generated %}
                                <button type="button" class="btn btn-sm btn-warning" 
                                        data-bs-toggle="modal" data-bs-target="#ddtModal{{ task.id_task }}">
                                    <i class="fas fa-file-alt"></i> DDT
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" data-bs-target="#deleteModal{{ task.id_task }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Modals for Active Tasks (outside the loop) -->
            {% for task in active_tasks %}
                {% include 'tasks/task_modals.html' %}
            {% endfor %}
            
            {% else %}
            <div class="task-empty-state">
                <i class="fas fa-tasks"></i>
                <h5>Nessun task attivo</h5>
                <p>Non ci sono task attualmente in lavorazione. Tutti i task sono stati completati o non sono ancora stati creati.</p>
                <a href="{{ url_for('tasks.create_task') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Crea Primo Task
                </a>
            </div>
            {% endif %}
            
            <!-- Delete All Tasks Button -->
            {% if active_tasks or completed_tasks %}
            <div class="text-center mt-4">
                <button type="button" class="btn btn-outline-danger" 
                        data-bs-toggle="modal" data-bs-target="#deleteAllModal">
                    <i class="fas fa-trash-alt"></i> Elimina Tutti i Task
                </button>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Completed Tasks Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-check-circle me-2 text-primary"></i>Task Completati ({{ completed_tasks|length }})
            </h5>
            <small class="text-muted">Task completati e processati</small>
        </div>
        <div class="card-body">
            {% if completed_tasks %}
            <div class="row">
                {% for task in completed_tasks %}
                <div class="col-lg-6 col-xl-4 mb-3">
                    <div class="task-card task-completed">
                        <div class="task-card-header">
                            <h6 class="task-card-title">{{ task.task_number }}</h6>
                            <div>
                                <span class="task-status-badge task-status-completed">
                                    Completato
                                </span>
                                {% if task.ddt_generated %}
                                <span class="badge bg-success ms-1">
                                    <i class="fas fa-file-alt"></i> DDT
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="task-card-body">
                            <h6 class="mb-2">{{ task.title }}</h6>
                            
                            <!-- Progress -->
                            <div class="task-progress">
                                <div class="task-progress-label">
                                    <span>Completato</span>
                                    <span><i class="fas fa-check text-success"></i> {{ task.total_tickets }}/{{ task.total_tickets }}</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill" style="width: 100%"></div>
                                </div>
                            </div>

                            <!-- Task Meta -->
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <span class="task-meta-label">Completato</span>
                                    <span class="task-meta-value">{{ task.created_at.strftime('%d/%m/%Y') }}</span>
                                </div>
                                <div class="task-meta-item">
                                    <span class="task-meta-label">Assegnato a</span>
                                    <span class="task-meta-value">{{ task.assignee.username if task.assignee else 'Sistema' }}</span>
                                </div>
                            </div>

                            {% if task.ddt_generated and task.client %}
                            <div class="mt-2">
                                <span class="task-meta-label">Cliente DDT:</span>
                                <span class="text-success">{{ task.client.Nombre }}</span>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="task-card-footer">
                            <div class="btn-group">
                                <a href="{{ url_for('tasks.view_task', task_id=task.id_task) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> Visualizza
                                </a>
                                {% if task.ddt_generated and task.ddt_id %}
                                <a href="{{ url_for('ddt.detail', ddt_id=task.ddt_id) }}" 
                                   class="btn btn-sm btn-success">
                                    <i class="fas fa-file-alt"></i> DDT #{{ task.ddt_id }}
                                </a>
                                {% endif %}
                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                        data-bs-toggle="modal" data-bs-target="#deleteModal{{ task.id_task }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Modals for Completed Tasks (outside the loop) -->
            {% for task in completed_tasks %}
                {% include 'tasks/task_modals.html' %}
            {% endfor %}
            
            {% else %}
            <div class="task-empty-state">
                <i class="fas fa-check-circle"></i>
                <h5>Nessun task completato</h5>
                <p>Non ci sono ancora task completati. I task completati appariranno qui una volta terminati.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete All Tasks Modal -->
{% if active_tasks or completed_tasks %}
<div class="modal fade" id="deleteAllModal" tabindex="-1" aria-labelledby="deleteAllModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAllModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Elimina Tutti i Task
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('tasks.delete_all_tasks') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>ATTENZIONE!</strong> Questa azione è irreversibile e eliminerà TUTTI i task.
                    </div>
                    <p><strong>Stai per eliminare:</strong></p>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-tasks text-primary"></i> <strong>Task attivi:</strong> {{ active_tasks|length }}</li>
                        <li><i class="fas fa-check-circle text-success"></i> <strong>Task completati:</strong> {{ completed_tasks|length }}</li>
                        <li><i class="fas fa-list text-info"></i> <strong>Totale task:</strong> {{ (active_tasks|length) + (completed_tasks|length) }}</li>
                    </ul>
                    <div class="alert alert-warning">
                        <i class="fas fa-undo"></i>
                        <strong>Conseguenze:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Tutti i ticket associati torneranno allo stato <code>Enviado = 0</code></li>
                            <li>Tutte le scansioni e i progressi saranno persi</li>
                            <li>Tutte le notifiche saranno eliminate</li>
                            <li>I ticket saranno nuovamente disponibili per l'assegnazione</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash-alt"></i> Elimina Tutti i Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<script>
$(document).ready(function() {
    // Auto-submit form on filter change
    $('#filterForm input, #filterForm select').on('change', function() {
        $('#filterForm').submit();
    });

    // Update progress bars
    $('.task-progress-fill').each(function() {
        const width = $(this).css('width');
        $(this).css('width', '0').animate({width: width}, 1000);
    });

    // Add tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Modal debugging
    console.log('Task dashboard loaded');
    console.log('Modals found:', $('[id^="deleteModal"]').length);
    
    // Ensure modals work properly
    $('[data-bs-toggle="modal"]').on('click', function(e) {
        const target = $(this).attr('data-bs-target');
        console.log('Modal target:', target);
        
        if ($(target).length === 0) {
            console.error('Modal not found:', target);
            e.preventDefault();
            alert('Errore: Modal non trovato. Controlla la console.');
            return false;
        }
    });
});
</script>
{% endblock %} 