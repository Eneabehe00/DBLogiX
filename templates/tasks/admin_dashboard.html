{% extends "base.html" %}
{% from 'components/search_and_stats.html' import render_search_section, render_stats_grid, render_search_results_info, render_active_filters %}

{% block title %}Task Management - Dashboard Admin{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
// Task-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Task cards are now handled by the global clickable-card handler in main.js
    
    // Handle task action buttons
    document.addEventListener('click', function(e) {
        if (e.target.closest('.task-action-btn')) {
            e.stopPropagation();
            const btn = e.target.closest('.task-action-btn');
            const action = btn.getAttribute('data-action');
            const taskId = btn.getAttribute('data-task-id');
            
            switch(action) {
                case 'edit':
                    window.location.href = `/tasks/edit/${taskId}`;
                    break;
                case 'view':
                    window.location.href = `/tasks/task/${taskId}`;
                    break;
                case 'ddt':
                    window.location.href = `/tasks/task/${taskId}/preview_ddt`;
                    break;
            }
        }
    });
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const searchInput = document.querySelector('.unified-search-input');
            if (searchInput) {
                searchInput.focus();
                searchInput.select();
            }
        }
    });

    // Handle clickable cards hover effect for task cards specifically
    const clickableCards = document.querySelectorAll('.task-card.clickable-card');
    clickableCards.forEach(function(card) {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 20px rgba(44, 62, 80, 0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
        });
    });

    console.log('Task dashboard loaded with enhanced features');
});

// Clear all filters function
function clearFilters() {
    window.location.href = '{{ url_for("tasks.admin_dashboard") }}';
}
</script>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header shadow-sm mb-4">
    <div class="container-fluid">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('warehouse.index') }}" class="text-white">Home</a></li>
                <li class="breadcrumb-item active text-white-50" aria-current="page">Task Management</li>
            </ol>
        </nav>
        <div class="row align-items-center mt-3">
            <div class="col-md-8">
                <h1 class="page-title mb-0">
                    <i class="fas fa-tasks me-2"></i>Task Management - Admin
                </h1>
                <p class="page-subtitle mt-2 mb-0">
                    <span class="text-white-50">{{ stats.total_tasks }} tasks totali nel sistema</span>
                    {% if search %}
                    <span class="status-badge info ms-2">
                        <i class="fas fa-search me-1"></i>Ricerca attiva
                    </span>
                    {% endif %}
                </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="d-grid d-md-block gap-2">
                    <a href="{{ url_for('tasks.create_task') }}" class="btn btn-light action-btn mb-2 mb-md-0">
                        <i class="fas fa-plus me-1"></i>Crea Nuovo Task
                    </a>
                    <a href="{{ url_for('tasks.notifications') }}" class="btn btn-light action-btn position-relative">
                        <i class="fas fa-bell me-1"></i>Notifiche
                        {% if stats.pending_tasks > 0 %}
                        <span class="badge bg-danger position-absolute" style="top: -8px; right: -8px; font-size: 0.7rem;">{{ stats.pending_tasks }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Unified Search Section -->
    {{ render_search_section({
        'title': 'Ricerca Tasks',
        'action': url_for('tasks.admin_dashboard'),
        'search_param': 'query',
        'placeholder': 'Cerca per ID, numero task, titolo, descrizione...',
        'current_value': search or '',
        'show_help': true,
        'help_text': 'Ricerca in tempo reale attraverso ID, numero, titolo e descrizione',
        'preserve_params': {
            'date_from': current_filters.date_from,
            'date_to': current_filters.date_to,
            'priority': current_filters.priority,
            'status': current_filters.status
        },
        'advanced_filters': [
            {
                'id': 'startDate',
                'name': 'date_from',
                'label': 'ðŸ“… Data inizio',
                'type': 'date',
                'value': current_filters.date_from
            },
            {
                'id': 'endDate',
                'name': 'date_to',
                'label': 'ðŸ“… Data fine',
                'type': 'date',
                'value': current_filters.date_to
            },
            {
                'id': 'priorityFilter',
                'name': 'priority',
                'label': 'ðŸŽ¯ PrioritÃ ',
                'type': 'select',
                'value': current_filters.priority,
                'options': [
                    {'value': 'low', 'label': 'Bassa'},
                    {'value': 'medium', 'label': 'Media'},
                    {'value': 'high', 'label': 'Alta'}
                ]
            },
            {
                'id': 'statusFilter',
                'name': 'status',
                'label': 'ðŸ“Š Stato',
                'type': 'select',
                'value': current_filters.status,
                'options': [
                    {'value': 'pending', 'label': 'In Attesa'},
                    {'value': 'assigned', 'label': 'Assegnato'},
                    {'value': 'in_progress', 'label': 'In Corso'},
                    {'value': 'completed', 'label': 'Completato'}
                ]
            }
        ]
    }) }}

    <!-- Unified Stats Grid -->
    {{ render_stats_grid([
        {
            'value': stats.total_tasks,
            'label': 'Task Totali',
            'icon': 'fas fa-list',
            'variant': ''
        },
        {
            'value': stats.pending_tasks,
            'label': 'In Attesa',
            'icon': 'fas fa-clock',
            'variant': 'stat-warning'
        },
        {
            'value': stats.in_progress_tasks,
            'label': 'In Corso',
            'icon': 'fas fa-play',
            'variant': 'stat-info'
        },
        {
            'value': stats.completed_tasks,
            'label': 'Completati',
            'icon': 'fas fa-check',
            'variant': 'stat-success'
        },
        {
            'value': stats.overdue_tasks,
            'label': 'Scaduti',
            'icon': 'fas fa-exclamation-triangle',
            'variant': 'stat-danger'
        },
        {
            'value': (active_tasks|length) + (completed_tasks|length) + (overdue_tasks|length),
            'label': 'Visualizzati',
            'icon': 'fas fa-eye',
            'variant': ''
        }
    ]) }}

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Search Results Info -->
    {{ render_search_results_info({
        'is_search_active': search,
        'search_term': search,
        'total_results': (active_tasks|length) + (completed_tasks|length) + (overdue_tasks|length),
        'clear_url': url_for('tasks.admin_dashboard', date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status)
    }) }}

    <!-- Active Filters Info -->
    {% if current_filters.date_from or current_filters.date_to or current_filters.priority or current_filters.status %}
    {% set active_filters = [] %}
    {% if current_filters.date_from or current_filters.date_to %}
        {% set date_label = "Dal " + current_filters.date_from + " al " + current_filters.date_to if current_filters.date_from and current_filters.date_to else "Da " + current_filters.date_from if current_filters.date_from else "Fino al " + current_filters.date_to %}
        {% set _ = active_filters.append({'icon': 'fas fa-calendar', 'label': 'Data', 'value': date_label}) %}
    {% endif %}
    {% if current_filters.priority %}
        {% set _ = active_filters.append({'icon': 'fas fa-flag', 'label': 'PrioritÃ ', 'value': current_filters.priority.title()}) %}
    {% endif %}
    {% if current_filters.status %}
        {% set _ = active_filters.append({'icon': 'fas fa-info-circle', 'label': 'Stato', 'value': current_filters.status.replace('_', ' ').title()}) %}
    {% endif %}
    
    {{ render_active_filters(active_filters + [{'clear_all_url': url_for('tasks.admin_dashboard')}] if active_filters else none) }}
    {% endif %}

    <!-- Task Scaduti Section -->
    {% if overdue_tasks or (search and overdue_total_pages > 0) %}
    <div class="card shadow-sm mb-4 border-danger">
        <div class="card-header bg-danger bg-opacity-10 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Task Scaduti ({{ overdue_tasks|length }})
            </h5>
            <small class="text-danger">Task che hanno superato la scadenza</small>
        </div>
        <div class="card-body">
            {% if overdue_tasks %}
            <div class="row">
                {% for task in overdue_tasks %}
                <div class="col-lg-6 col-xl-4 mb-3">
                    <div class="task-card task-overdue clickable-card" data-href="{{ url_for('tasks.view_task', task_id=task.id_task) }}">
                        <div class="task-card-header">
                            <h6 class="task-card-title">{{ task.task_number }}</h6>
                            <div>
                                <span class="task-status-badge task-status-overdue">
                                    Scaduto
                                </span>
                                <span class="task-priority-badge task-priority-{{ task.priority }}">
                                    {{ task.priority.title() }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="task-card-body">
                            <h6 class="mb-2">{{ task.title }}</h6>
                            
                            <!-- Progress -->
                            <div class="task-progress">
                                <div class="task-progress-label">
                                    <span>Progresso</span>
                                    <span>{{ task.completed_tickets }}/{{ task.total_tickets }}</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill bg-danger" style="width: {% if task.total_tickets > 0 %}{{ (task.completed_tickets / task.total_tickets * 100)|round|int }}%{% else %}0%{% endif %}"></div>
                                </div>
                            </div>
                            
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>{{ task.assigned_user.username if task.assigned_user else 'Non assegnato' }}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-calendar text-danger"></i>
                                    <span>Scad: {{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="task-card-footer">
                            {% if current_user.is_admin %}
                            <button class="btn btn-sm btn-outline-primary task-action-btn" data-action="edit" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-edit"></i> Modifica
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-success task-action-btn" data-action="view" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-eye"></i> Dettagli
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination for Overdue Tasks -->
            {% if overdue_total_pages > 1 %}
            <nav aria-label="Overdue tasks pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if overdue_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', overdue_page=overdue_page-1, active_page=active_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Precedente</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in range(1, overdue_total_pages + 1) %}
                    <li class="page-item {% if page_num == overdue_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', overdue_page=page_num, active_page=active_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if overdue_page < overdue_total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', overdue_page=overdue_page+1, active_page=active_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Successiva</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                <h5 class="text-muted">Nessun task scaduto</h5>
                <p class="text-muted">Ottimo! Non ci sono task in ritardo</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Task Attivi Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-tasks me-2 text-primary"></i>Task Attivi ({{ active_tasks|length }})
            </h5>
            <small class="text-muted">Task in corso di lavorazione</small>
        </div>
        <div class="card-body">
            {% if active_tasks %}
            <div class="row">
                {% for task in active_tasks %}
                <div class="col-lg-6 col-xl-4 mb-3">
                    <div class="task-card task-{{ task.status }} clickable-card" data-href="{{ url_for('tasks.view_task', task_id=task.id_task) }}">
                        <div class="task-card-header">
                            <h6 class="task-card-title">{{ task.task_number }}</h6>
                            <div>
                                <span class="task-status-badge task-status-{{ task.status }}">
                                    {{ task.status.replace('_', ' ').title() }}
                                </span>
                                <span class="task-priority-badge task-priority-{{ task.priority }}">
                                    {{ task.priority.title() }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="task-card-body">
                            <h6 class="mb-2">{{ task.title }}</h6>
                            
                            <!-- Progress -->
                            <div class="task-progress">
                                <div class="task-progress-label">
                                    <span>Progresso</span>
                                    <span>{{ task.completed_tickets }}/{{ task.total_tickets }}</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill" style="width: {% if task.total_tickets > 0 %}{{ (task.completed_tickets / task.total_tickets * 100)|round|int }}%{% else %}0%{% endif %}"></div>
                                </div>
                            </div>
                            
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>{{ task.assigned_user.username if task.assigned_user else 'Non assegnato' }}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    <span>{{ task.created_at.strftime('%d/%m/%Y') if task.created_at else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="task-card-footer">
                            {% if current_user.is_admin %}
                            <button class="btn btn-sm btn-outline-primary task-action-btn" data-action="edit" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-edit"></i> Modifica
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-outline-success task-action-btn" data-action="view" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-eye"></i> Dettagli
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination for Active Tasks -->
            {% if active_total_pages > 1 %}
            <nav aria-label="Active tasks pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if active_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', active_page=active_page-1, overdue_page=overdue_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Precedente</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in range(1, active_total_pages + 1) %}
                    <li class="page-item {% if page_num == active_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', active_page=page_num, overdue_page=overdue_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if active_page < active_total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', active_page=active_page+1, overdue_page=overdue_page, completed_page=completed_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Successiva</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nessun task attivo</h5>
                <p class="text-muted">Tutti i task sono stati completati o non ce ne sono di assegnati</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Task Completati Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-transparent d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-check-circle me-2 text-success"></i>Task Completati ({{ completed_tasks|length }})
            </h5>
            <small class="text-muted">Task terminati con successo</small>
        </div>
        <div class="card-body">
            {% if completed_tasks %}
            <div class="row">
                {% for task in completed_tasks %}
                <div class="col-lg-6 col-xl-4 mb-3">
                    <div class="task-card task-completed clickable-card" data-href="{{ url_for('tasks.view_task', task_id=task.id_task) }}">
                        <div class="task-card-header">
                            <h6 class="task-card-title">{{ task.task_number }}</h6>
                            <div>
                                <span class="task-status-badge task-status-completed">
                                    Completato
                                </span>
                                <span class="task-priority-badge task-priority-{{ task.priority }}">
                                    {{ task.priority.title() }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="task-card-body">
                            <h6 class="mb-2">{{ task.title }}</h6>
                            
                            <!-- Progress -->
                            <div class="task-progress">
                                <div class="task-progress-label">
                                    <span>Progresso</span>
                                    <span>{{ task.completed_tickets }}/{{ task.total_tickets }}</span>
                                </div>
                                <div class="task-progress-bar">
                                    <div class="task-progress-fill bg-success" style="width: 100%"></div>
                                </div>
                            </div>
                            
                            <div class="task-meta">
                                <div class="task-meta-item">
                                    <i class="fas fa-user"></i>
                                    <span>{{ task.assigned_user.username if task.assigned_user else 'Non assegnato' }}</span>
                                </div>
                                <div class="task-meta-item">
                                    <i class="fas fa-check text-success"></i>
                                    <span>{{ task.completed_at.strftime('%d/%m/%Y') if task.completed_at else 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="task-card-footer">
                            <button class="btn btn-sm btn-outline-success task-action-btn" data-action="view" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-eye"></i> Dettagli
                            </button>
                            {% if task.is_completed and not task.ddt_generated and current_user.is_admin %}
                            <button class="btn btn-sm btn-outline-info task-action-btn" data-action="ddt" data-task-id="{{ task.id_task }}">
                                <i class="fas fa-file-alt"></i> Genera DDT
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <!-- Pagination for Completed Tasks -->
            {% if completed_total_pages > 1 %}
            <nav aria-label="Completed tasks pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if completed_page > 1 %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', completed_page=completed_page-1, active_page=active_page, overdue_page=overdue_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Precedente</a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in range(1, completed_total_pages + 1) %}
                    <li class="page-item {% if page_num == completed_page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', completed_page=page_num, active_page=active_page, overdue_page=overdue_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">{{ page_num }}</a>
                    </li>
                    {% endfor %}
                    
                    {% if completed_page < completed_total_pages %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('tasks.admin_dashboard', completed_page=completed_page+1, active_page=active_page, overdue_page=overdue_page, query=search, date_from=current_filters.date_from, date_to=current_filters.date_to, priority=current_filters.priority, status=current_filters.status) }}">Successiva</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Nessun task completato</h5>
                <p class="text-muted">I task completati appariranno qui</p>
            </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %} 