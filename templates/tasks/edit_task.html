{% extends "base.html" %}

{% block title %}Modifica Task - {{ task.task_number }}{% endblock %}

{% block header_title %}Modifica Task - {{ task.task_number }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks.css') }}">
<style>
    /* Elegant Dark Theme - DDT Style per Edit Task */
    :root {
        --primary-dark: #2c3e50;
        --secondary-dark: #34495e;
        --accent-blue: #3498db;
        --success-green: #27ae60;
        --warning-orange: #f39c12;
        --danger-red: #e74c3c;
        --light-gray: #ecf0f1;
        --text-secondary: #34495e;
        --text-info: #2980b9;
        --text-dark: #2c3e50;
        --white: #ffffff;
        --border-light: #e9ecef;
    }

    /* Task View Card Style */
    .task-view-card {
        background: var(--white);
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        margin-bottom: 25px;
        border: 1px solid var(--border-light);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .task-view-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
    }

    .section-header {
        background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%);
        color: var(--white);
        padding: 18px 25px;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 3px solid var(--accent-blue);
    }

    .section-body {
        padding: 25px;
    }

    /* Form Styling */
    .form-control {
        border: 2px solid var(--border-light);
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
    }

    .form-label {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-label i {
        margin-right: 8px;
        width: 16px;
        text-align: center;
    }

    /* Buttons */
    .btn {
        border-radius: 10px;
        font-weight: 600;
        padding: 12px 24px;
        transition: all 0.3s ease;
        border: none;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #2980b9 100%);
        color: var(--white);
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #2980b9 0%, #1f5f8b 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
        color: var(--white);
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #229954 0%, #1e7e4a 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
    }

    .btn-warning {
        background: linear-gradient(135deg, var(--warning-orange) 0%, #e67e22 100%);
        color: var(--white);
    }

    .btn-warning:hover {
        background: linear-gradient(135deg, #e67e22 0%, #c0661f 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger-red) 0%, #c0392b 100%);
        color: var(--white);
    }

    .btn-danger:hover {
        background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, var(--text-secondary) 0%, #95a5a6 100%);
        color: var(--text-dark);
    }

    .btn-secondary:hover {
        background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(149, 165, 166, 0.4);
    }

    /* Ticket Card Styling - Enhanced Details */
    .ticket-edit-card {
        background: var(--white);
        border: 2px solid var(--border-light);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        position: relative;
        cursor: pointer;
    }

    .ticket-edit-card:hover {
        border-color: var(--accent-blue);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
    }

    .ticket-edit-card.completed {
        border-color: var(--success-green);
        background: linear-gradient(135deg, rgba(39, 174, 96, 0.03) 0%, rgba(39, 174, 96, 0.08) 100%);
    }

    .ticket-edit-card.in-progress {
        border-color: var(--warning-orange);
        background: linear-gradient(135deg, rgba(243, 156, 18, 0.03) 0%, rgba(243, 156, 18, 0.08) 100%);
    }

    .ticket-edit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 2px solid var(--border-light);
    }

    .ticket-edit-number {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--primary-dark);
        background: linear-gradient(135deg, var(--accent-blue) 0%, #2980b9 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .ticket-edit-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .ticket-status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.status-pending {
        background: linear-gradient(135deg, var(--text-secondary) 0%, #95a5a6 100%);
        color: var(--white);
    }

    .status-badge.status-assigned {
        background: linear-gradient(135deg, var(--accent-blue) 0%, #2980b9 100%);
        color: var(--white);
    }

    .status-badge.status-in_progress {
        background: linear-gradient(135deg, var(--warning-orange) 0%, #e67e22 100%);
        color: var(--white);
    }

    .status-badge.status-completed {
        background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);
        color: var(--white);
    }

    .status-badge.status-paused {
        background: linear-gradient(135deg, var(--text-secondary) 0%, #95a5a6 100%);
        color: var(--white);
    }

    .btn-remove-ticket {
        background: var(--danger-red);
        color: var(--white);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .btn-remove-ticket:hover {
        background: #c0392b;
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
    }

    /* Ticket Details Section */
    .ticket-edit-details {
        margin-bottom: 15px;
    }

    .ticket-product-showcase {
        background: var(--light-gray);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .ticket-product-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-dark);
        margin-bottom: 8px;
    }

    .ticket-product-details {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 0.9rem;
        color: var(--text-dark);
    }

    .ticket-product-detail {
        display: flex;
        align-items: center;
        gap: 5px;
        background: var(--white);
        padding: 5px 10px;
        border-radius: 8px;
        border: 1px solid var(--border-light);
    }

    .ticket-product-detail i {
        color: var(--accent-blue);
        width: 16px;
        text-align: center;
    }

    .expiry-warning {
        color: var(--warning-orange);
        font-weight: 600;
    }

    .expiry-danger {
        color: var(--danger-red);
        font-weight: 600;
    }

    .ticket-edit-footer {
        margin-top: 15px;
    }

    .ticket-edit-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        font-size: 0.9rem;
        color: var(--text-dark);
        margin-bottom: 10px;
    }

    .ticket-edit-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
        background: var(--light-gray);
        padding: 5px 10px;
        border-radius: 8px;
    }

    .ticket-edit-meta i {
        color: var(--accent-blue);
        width: 16px;
        text-align: center;
    }

    /* Progress Bar */
    .ticket-progress {
        height: 6px;
        background: var(--border-light);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 10px;
    }

    .ticket-progress-fill {
        height: 100%;
        transition: width 0.3s ease;
        border-radius: 3px;
    }

    .progress-none {
        background: var(--text-secondary);
        width: 0%;
    }

    .progress-partial {
        background: linear-gradient(90deg, var(--warning-orange) 0%, #e67e22 100%);
    }

    .progress-complete {
        background: linear-gradient(90deg, var(--success-green) 0%, #229954 100%);
    }

    /* Task Info Grid */
    .task-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .task-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: var(--light-gray);
        border-radius: 10px;
        border-left: 4px solid var(--accent-blue);
    }

    .task-info-label {
        font-weight: 600;
        color: var(--text-dark);
        font-size: 0.9rem;
    }

    .task-info-value {
        font-weight: 700;
        color: var(--primary-dark);
        font-size: 1rem;
    }

    .priority-badge {
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .priority-badge.priority-low {
        background: var(--text-secondary);
        color: var(--white);
    }

    .priority-badge.priority-medium {
        background: var(--warning-orange);
        color: var(--white);
    }

    .priority-badge.priority-high {
        background: var(--danger-red);
        color: var(--white);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .section-body {
            padding: 20px;
        }
        
        .ticket-edit-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .ticket-edit-actions {
            align-self: flex-end;
        }
        
        .ticket-product-details {
            flex-direction: column;
            gap: 8px;
        }
        
        .ticket-edit-meta {
            flex-direction: column;
            gap: 8px;
        }
        
        .task-info-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Animation */
    .loading-spinner {
        border: 4px solid var(--border-light);
        border-top: 4px solid var(--accent-blue);
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Alert Styling */
    .alert {
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 20px;
        border: none;
        font-weight: 500;
    }

    .alert-danger {
        background: linear-gradient(135deg, rgba(231, 76, 60, 0.1) 0%, rgba(231, 76, 60, 0.2) 100%);
        color: var(--danger-red);
        border-left: 4px solid var(--danger-red);
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(52, 152, 219, 0.1) 0%, rgba(52, 152, 219, 0.2) 100%);
        color: var(--accent-blue);
        border-left: 4px solid var(--accent-blue);
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/tasks.js') }}"></script>
{% endblock %}

{% block content %}
    <div class="container-fluid">
    <!-- Task Form -->
    <div class="task-view-card">
        <div class="section-header">
            <span>
                <i class="fas fa-edit me-2"></i>Modifica Informazioni Task
            </span>
            <div class="d-flex align-items-center gap-3">
                <small class="text-white-50">Task #{{ task.task_number }}</small>
                <a href="{{ url_for('tasks.view_task', task_id=task.id_task) }}" class="btn btn-sm btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Torna al Task
                    </a>
            </div>
        </div>
        <div class="section-body">
                    <form method="POST" action="{{ url_for('tasks.edit_task', task_id=task.id_task) }}" id="editTaskForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Task Details -->
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="title" class="form-label">
                                        <i class="fas fa-heading text-primary"></i> Titolo Task *
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="title" 
                                           name="title" 
                                           value="{{ task.title }}"
                                           required 
                                           maxlength="200"
                                           placeholder="Inserisci un titolo descrittivo per il task">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">
                                        <i class="fas fa-flag text-warning"></i> Priorità
                                    </label>
                                    <select class="form-control" id="priority" name="priority">
                                        <option value="low" {% if task.priority == 'low' %}selected{% endif %}>Bassa</option>
                                        <option value="medium" {% if task.priority == 'medium' %}selected{% endif %}>Media</option>
                                        <option value="high" {% if task.priority == 'high' %}selected{% endif %}>Alta</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="deadline" class="form-label">
                                        <i class="fas fa-clock text-danger"></i> Data di Scadenza (Opzionale)
                                    </label>
                                    <input type="datetime-local" 
                                           class="form-control" 
                                           id="deadline" 
                                           name="deadline"
                                           value="{{ task.deadline.strftime('%Y-%m-%dT%H:%M') if task.deadline }}">
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i> Se specificata, solo i ticket con prodotti non scaduti oltre questa data saranno utilizzabili.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assignee" class="form-label">
                                        <i class="fas fa-user text-success"></i> Assegnato a
                                    </label>
                                    <select class="form-control" id="assignee" name="assignee_id">
                                        <option value="">Non assegnato</option>
                                        {% for user in users %}
                                        <option value="{{ user.id }}" {% if task.assignee and task.assignee.id == user.id %}selected{% endif %}>
                                            {{ user.username }} ({{ user.email }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">
                                <i class="fas fa-align-left text-info"></i> Descrizione (Opzionale)
                            </label>
                            <textarea class="form-control" 
                                      id="description" 
                                      name="description" 
                                      rows="3" 
                                      placeholder="Aggiungi una descrizione dettagliata del task...">{{ task.description or '' }}</textarea>
                        </div>

                        <!-- Actions -->
                <div class="d-flex justify-content-between flex-wrap gap-2">
                    <div class="d-flex gap-2 flex-wrap">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Salva Modifiche
                                </button>
                                <a href="{{ url_for('tasks.view_task', task_id=task.id_task) }}" class="btn btn-secondary">
                                    <i class="fas fa-times"></i> Annulla
                                </a>
                            </div>
                    {% if not (task.ddt_generated and task.ddt_id) %}
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteTaskModal">
                        <i class="fas fa-trash"></i> Elimina Task
                    </button>
                    {% endif %}
                        </div>
                    </form>
                </div>
            </div>

    <!-- Task Information -->
    <div class="task-view-card">
        <div class="section-header">
            <span>
                <i class="fas fa-info-circle me-2"></i>Informazioni Task
            </span>
        </div>
        <div class="section-body">
            <div class="task-info-grid">
                <div class="task-info-item">
                    <span class="task-info-label">Numero Task</span>
                    <span class="task-info-value">{{ task.task_number }}</span>
                </div>
                <div class="task-info-item">
                    <span class="task-info-label">Status</span>
                            <span class="status-badge task-status-{{ task.status }}">
                                {{ task.status.replace('_', ' ').title() }}
                            </span>
                        </div>
                <div class="task-info-item">
                    <span class="task-info-label">Creato il</span>
                    <span class="task-info-value">{{ task.created_at.strftime('%d/%m/%Y %H:%M') }}</span>
                </div>
                <div class="task-info-item">
                    <span class="task-info-label">Creato da</span>
                    <span class="task-info-value">{{ task.creator.username }}</span>
                </div>
                <div class="task-info-item">
                    <span class="task-info-label">Ticket Associati</span>
                    <span class="task-info-value">{{ task.total_tickets }}</span>
                </div>
                <div class="task-info-item">
                    <span class="task-info-label">Progresso</span>
                    <span class="task-info-value">{{ task.completed_tickets }}/{{ task.total_tickets }} ({{ task.progress_percentage }}%)</span>
                        </div>
                {% if task.assignee %}
                <div class="task-info-item">
                    <span class="task-info-label">Assegnato a</span>
                    <span class="task-info-value">{{ task.assignee.username }}</span>
                        </div>
                {% endif %}
                {% if task.deadline %}
                <div class="task-info-item">
                    <span class="task-info-label">Scadenza</span>
                    <span class="task-info-value {% if task.is_overdue %}text-danger{% elif task.deadline and (task.deadline - now()).days < 1 %}text-warning{% endif %}">
                        {{ task.deadline.strftime('%d/%m/%Y %H:%M') }}
                    </span>
                        </div>
                {% endif %}
                <div class="task-info-item">
                    <span class="task-info-label">Priorità</span>
                    <div class="task-info-value">
                        <span class="priority-badge task-priority-{{ task.priority }}">{{ task.priority.upper() }}</span>
                    </div>
                </div>
            </div>

            {% if task.description %}
            <div class="mt-3">
                <span class="task-info-label">Descrizione</span>
                <div class="task-info-value mt-2" style="background: var(--light-gray); padding: 15px; border-radius: 10px;">
                    {{ task.description }}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- DDT Information (if generated) -->
    {% if task.ddt_generated and task.ddt_id %}
    <div class="task-view-card">
        <div class="section-header" style="background: linear-gradient(135deg, var(--success-green) 0%, #229954 100%);">
            <span>
                <i class="fas fa-file-alt me-2"></i>DDT Generato
            </span>
        </div>
        <div class="section-body">
            <div class="task-info-grid">
                <div class="task-info-item">
                    <span class="task-info-label">Cliente</span>
                    <span class="task-info-value">{{ task.client.Nombre if task.client else 'N/A' }}</span>
                </div>
                <div class="task-info-item">
                    <span class="task-info-label">DDT ID</span>
                    <span class="task-info-value">#{{ task.ddt_id }}</span>
                </div>
            </div>
            {% if task.ddt_id %}
            <div class="text-center mt-3">
                <a href="{{ url_for('ddt.detail', ddt_id=task.ddt_id) }}" class="btn btn-success">
                    <i class="fas fa-external-link-alt me-2"></i>Visualizza DDT
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Ticket Associati con Dettagli Ricchi -->
    <div class="task-view-card">
        <div class="section-header">
            <span>
                <i class="fas fa-ticket-alt me-2"></i>Ticket Associati ({{ task.total_tickets }})
            </span>
            <div class="d-flex align-items-center gap-3">
                <small class="text-white-50">{{ task.completed_tickets }} completati</small>
                {% if task.total_tickets > 0 %}
                <span class="badge bg-light text-dark">{{ task.progress_percentage }}% progresso</span>
                {% endif %}
            </div>
        </div>
        <div class="section-body">
                    {% if task.task_tickets %}
                    <div class="row">
                        {% for task_ticket in task.task_tickets %}
                <div class="col-lg-6 col-xl-12 mb-3">
                            <div class="ticket-edit-card {% if task_ticket.status == 'completed' %}completed{% elif task_ticket.status == 'in_progress' %}in-progress{% endif %} clickable-card" 
                                 data-href="{{ url_for('warehouse.ticket_detail', ticket_id=task_ticket.ticket_id) }}">
                                
                                <!-- Header con numero e status -->
                                <div class="ticket-edit-header">
                            <div class="ticket-edit-number">Ticket #{{ task_ticket.ticket.IdTicket }}</div>
                                    <div class="ticket-edit-actions">
                                        <span class="ticket-status-badge ticket-status-{{ task_ticket.status }}">
                                            {{ task_ticket.status.replace('_', ' ').title() }}
                                        </span>
                                {% if not (task.ddt_generated and task.ddt_id) %}
                                <button type="button" class="btn-remove-ticket" 
                                        data-task-ticket-id="{{ task_ticket.id }}" 
                                        data-ticket-number="{{ task_ticket.ticket.IdTicket }}"
                                        data-task-id="{{ task.id_task }}"
                                        title="Rimuovi ticket dal task">
                                            <i class="fas fa-times"></i>
                                        </button>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Prodotto principale con dettagli ricchi -->
                        <div class="ticket-edit-details">
                            {% if task_ticket.ticket.loaded_lines and task_ticket.ticket.loaded_lines|length > 0 %}
                                {% set main_line = task_ticket.ticket.loaded_lines[0] %}
                                <div class="ticket-product-showcase">
                                    <div class="ticket-product-name">{{ main_line.Descripcion }}</div>
                                    <div class="ticket-product-details">
                                        <div class="ticket-product-detail">
                                            <i class="fas fa-barcode"></i>
                                            <span>ID: {{ main_line.IdArticulo }}</span>
                                        </div>
                                        <div class="ticket-product-detail">
                                            <i class="fas fa-weight"></i>
                                            {% if main_line.comportamiento == 0 %}
                                            <span>{{ main_line.Peso|int if main_line.Peso == main_line.Peso|int else main_line.Peso }} unità</span>
                                            {% else %}
                                            <span>{{ "%.3f"|format(main_line.Peso|float)|replace('.000', '') }} kg</span>
                                            {% endif %}
                                        </div>
                                        {% if main_line.FechaCaducidad %}
                                        {% set expiry_date = main_line.FechaCaducidad.date() if main_line.FechaCaducidad.__class__.__name__ == 'datetime' else main_line.FechaCaducidad %}
                                        {% set today = now().date() %}
                                        {% set days_to_expiry = (expiry_date - today).days %}
                                        <div class="ticket-product-detail {% if days_to_expiry < 0 %}expiry-danger{% elif days_to_expiry < 7 %}expiry-warning{% endif %}">
                                            <i class="fas fa-calendar-times"></i>
                                            <span>
                                                Scade: {{ main_line.FechaCaducidad.strftime('%d/%m/%Y') if main_line.FechaCaducidad.__class__.__name__ == 'datetime' else main_line.FechaCaducidad.strftime('%d/%m/%Y') }}
                                                {% if days_to_expiry < 0 %}
                                                (scaduto {{ -days_to_expiry }} giorni fa)
                                                {% elif days_to_expiry == 0 %}
                                                (scade oggi)
                                                {% elif days_to_expiry < 7 %}
                                                ({{ days_to_expiry }} giorni)
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                        {% if task_ticket.ticket.loaded_lines|length > 1 %}
                                        <div class="ticket-product-detail">
                                            <i class="fas fa-plus-circle"></i>
                                            <span>+{{ task_ticket.ticket.loaded_lines|length - 1 }} altri prodotti</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% else %}
                                <div class="ticket-product-showcase">
                                    <div class="ticket-product-name text-muted">Prodotti non disponibili</div>
                                    <div class="ticket-product-details">
                                        <div class="ticket-product-detail">
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                            <span>Dati prodotto non caricati</span>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                                </div>

                                <!-- Info aggiuntive -->
                                <div class="ticket-edit-footer">
                                    <div class="ticket-edit-meta">
                                <span>
                                    <i class="fas fa-calendar"></i>
                                    {{ task_ticket.ticket.Fecha.strftime('%d/%m/%Y %H:%M') if task_ticket.ticket.Fecha else 'N/A' }}
                                </span>
                                <span>
                                    <i class="fas fa-box"></i>
                                    {{ task_ticket.ticket.NumLineas }} prodotti
                                </span>
                                <span>
                                    <i class="fas fa-chart-pie"></i>
                                    {{ task_ticket.scanned_items }}/{{ task_ticket.ticket.NumLineas }} scansionati
                                </span>
                                {% if task_ticket.ticket.CodigoBarras %}
                                <span>
                                    <i class="fas fa-qrcode"></i>
                                    {{ task_ticket.ticket.CodigoBarras[:10] }}...
                                </span>
                                {% endif %}
                            </div>
                            
                            <!-- Progress bar -->
                            <div class="ticket-progress">
                                <div class="ticket-progress-fill {% if task_ticket.scan_progress_percentage == 100 %}progress-complete{% elif task_ticket.scan_progress_percentage > 0 %}progress-partial{% else %}progress-none{% endif %}" 
                                     style="width: {{ task_ticket.scan_progress_percentage }}%"></div>
                                    </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">{{ task_ticket.scan_progress_percentage }}% completato</small>
                                    <small class="text-muted">
                                    <i class="fas fa-mouse-pointer"></i> Clicca per dettagli completi
                                    </small>
                                </div>
                        </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-ticket-alt fa-3x mb-3"></i>
                <h5>Nessun ticket associato</h5>
                <p class="mb-0">Non ci sono ticket associati a questo task.</p>
                    <div class="mt-3">
                    <a href="{{ url_for('tasks.view_task', task_id=task.id_task) }}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Gestisci Ticket
                        </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Delete Task Modal -->
{% if current_user.is_admin and not (task.ddt_generated and task.ddt_id) %}
<div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-labelledby="deleteTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteTaskModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Elimina Task: {{ task.task_number }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('tasks.delete_task', task_id=task.id_task) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Attenzione!</strong> Questa azione è irreversibile.
                    </div>
                    <p><strong>Stai per eliminare il task:</strong></p>
                    <div class="task-info-grid">
                        <div class="task-info-item">
                            <span class="task-info-label">Numero</span>
                            <span class="task-info-value">{{ task.task_number }}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">Titolo</span>
                            <span class="task-info-value">{{ task.title }}</span>
                        </div>
                        <div class="task-info-item">
                            <span class="task-info-label">Ticket associati</span>
                            <span class="task-info-value">{{ task.total_tickets }}</span>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Tutti i ticket associati torneranno allo stato <code>Enviado = 0</code> e saranno di nuovo disponibili per altri task.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Elimina Task
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Remove Ticket Modal -->
<div class="modal fade" id="removeTicketModal" tabindex="-1" aria-labelledby="removeTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="removeTicketModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Rimuovi Ticket dal Task
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('tasks.remove_ticket_from_task') }}" id="removeTicketForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="task_id" value="{{ task.id_task }}">
                <input type="hidden" name="task_ticket_id" id="removeTicketId">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Attenzione!</strong> Stai per rimuovere un ticket dal task.
                    </div>
                    <p>Vuoi davvero rimuovere il ticket <strong>#<span id="removeTicketNumber"></span></strong> dal task {{ task.task_number }}?</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Il ticket tornerà allo stato <code>Enviado = 0</code> e sarà di nuovo disponibile per altri task.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Annulla
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-unlink"></i> Rimuovi Ticket
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Initialize deadline validation
    initializeDeadlineValidation();
    
    // Form validation
    $('#editTaskForm').on('submit', function(e) {
        const title = $('#title').val().trim();
        
        if (!title) {
            e.preventDefault();
            alert('Il titolo del task è obbligatorio.');
            $('#title').focus();
            return false;
        }
        
        if (!validateDeadline()) {
            e.preventDefault();
            return false;
        }
        
        // Show loading
        $('button[type="submit"]').prop('disabled', true).html('<div class="loading-spinner"></div>Salvataggio...');
    });
    
    // Clickable cards
    $('.clickable-card').on('click', function(e) {
        // Don't navigate if clicking on remove button
        if ($(e.target).closest('.btn-remove-ticket').length > 0) {
            return;
        }
        
        const href = $(this).data('href');
        if (href) {
            window.open(href, '_blank');
        }
    });
    
    // Remove ticket functionality
    $('.btn-remove-ticket').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const taskTicketId = $(this).data('task-ticket-id');
        const ticketNumber = $(this).data('ticket-number');
        
        $('#removeTicketId').val(taskTicketId);
        $('#removeTicketNumber').text(ticketNumber);
        $('#removeTicketModal').modal('show');
    });
    
    // Remove ticket form submission
    $('#removeTicketForm').on('submit', function(e) {
        // Show loading
        $(this).find('button[type="submit"]').prop('disabled', true).html('<div class="loading-spinner"></div>Rimozione...');
    });
});

/**
 * Validate deadline is not in the past
 */
function validateDeadline() {
    const deadlineInput = $('#deadline');
    const deadlineValue = deadlineInput.val();
    
    if (!deadlineValue) {
        // Deadline is optional
        deadlineInput.removeClass('is-invalid');
        $('#deadline-feedback').remove();
        return true;
    }
    
    const selectedDate = new Date(deadlineValue);
    const now = new Date();
    
    // Compare only dates, not datetime, so today's date is allowed
    const selectedDateOnly = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    
    // Check if selected date is in the past
    if (selectedDateOnly < todayOnly) {
        deadlineInput.addClass('is-invalid');
        $('#deadline-feedback').remove();
        deadlineInput.after('<div class="invalid-feedback" id="deadline-feedback">La data di scadenza non può essere nel passato.</div>');
        return false;
    } else {
        deadlineInput.removeClass('is-invalid');
        $('#deadline-feedback').remove();
        return true;
    }
}

/**
 * Initialize deadline validation
 */
function initializeDeadlineValidation() {
    const deadlineInput = $('#deadline');
    
    // Set minimum date to today
    const today = new Date();
    const todayString = today.toISOString().slice(0, 16);
    deadlineInput.attr('min', todayString);
    
    // Add validation on change
    deadlineInput.on('change', function() {
        validateDeadline();
    });
}
</script>
{% endblock %}